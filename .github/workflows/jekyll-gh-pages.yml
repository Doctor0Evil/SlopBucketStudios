name: BitBot Queue Pending Workflows (Self‑Healing)

on:
  schedule:
    - cron: "*/15 * * * *"
  workflow_dispatch:

jobs:
  queue_pending:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Locate get_pending_workflows.py
        id: find_get
        run: |
          echo "🔍 Searching for get_pending_workflows.py..."
          SCRIPT_PATH=$(find . -type f -iname "get_pending_workflows.py" | head -n 1)
          if [ -z "$SCRIPT_PATH" ]; then
            echo "❌ ERROR: get_pending_workflows.py not found anywhere in repo."
            exit 1
          fi
          echo "✅ Found at: $SCRIPT_PATH"
          echo "script_path=$SCRIPT_PATH" >> $GITHUB_OUTPUT

      - name: Locate deploy_bitbot_agent.py
        id: find_deploy
        run: |
          echo "🔍 Searching for deploy_bitbot_agent.py..."
          SCRIPT_PATH=$(find . -type f -iname "deploy_bitbot_agent.py" | head -n 1)
          if [ -z "$SCRIPT_PATH" ]; then
            echo "❌ ERROR: deploy_bitbot_agent.py not found anywhere in repo."
            exit 1
          fi
          echo "✅ Found at: $SCRIPT_PATH"
          echo "script_path=$SCRIPT_PATH" >> $GITHUB_OUTPUT

      - name: Locate run_pending_with_bitbot.py
        id: find_run
        run: |
          echo "🔍 Searching for run_pending_with_bitbot.py..."
          SCRIPT_PATH=$(find . -type f -iname "run_pending_with_bitbot.py" | head -n 1)
          if [ -z "$SCRIPT_PATH" ]; then
            echo "❌ ERROR: run_pending_with_bitbot.py not found anywhere in repo."
            exit 1
          fi
          echo "✅ Found at: $SCRIPT_PATH"
          echo "script_path=$SCRIPT_PATH" >> $GITHUB_OUTPUT

      - name: Get Pending Workflows
        run: |
          python "${{ steps.find_get.outputs.script_path }}" > pending_wfs.json

      - name: Deploy BitBot Agents for Pending
        run: |
          python "${{ steps.find_deploy.outputs.script_path }}" \
            --input pending_wfs.json \
            --pattern ml.patterns.learn.bitbot.bit

      - name: Run Pending Workflows on BitBot
        run: |
          python "${{ steps.find_run.outputs.script_path }}" \
            --input pending_wfs.json

name: WTF Config – Locate get_pending_workflows.py

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  locate-script:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Search for get_pending_workflows.py
        id: search
        shell: bash
        run: |
          echo "🔍 Searching for get_pending_workflows.py..."
          SCRIPT_PATH=$(find . -type f -iname "get_pending_workflows.py" | head -n 1 || true)
          if [ -n "$SCRIPT_PATH" ]; then
            echo "✅ Found at: $SCRIPT_PATH"
            echo "script_path=$SCRIPT_PATH" >> "$GITHUB_OUTPUT"
          else
            echo "::warning::get_pending_workflows.py not found — continuing without it"
            echo "script_path=" >> "$GITHUB_OUTPUT"
          fi

      - name: Use script if present
        if: steps.search.outputs.script_path != ''
        run: |
          echo "Running ${{ steps.search.outputs.script_path }}..."
          python "${{ steps.search.outputs.script_path }}"

      - name: Log missing script
        if: steps.search.outputs.script_path == ''
        run: |
          mkdir -p .bithub/reports
          echo "{\"event\":\"missing_script\",\"script\":\"get_pending_workflows.py\",\"timestamp\":\"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}" \
            > .bithub/reports/missing_get_pending_workflows.json
          echo "Logged missing script event to .bithub/reports/"
